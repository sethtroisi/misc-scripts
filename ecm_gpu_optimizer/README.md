# GMP-ECM GPU Optimizer

Try to optimize B1/B2 bounds when B1 is run on GPU at a non-trivial speedup.

Given a B1 speedup compute optimal B1/B2 params.


## GPU timing

I calculate my GPU's B1 speed with

```
$ echo "(2^499-1)/20959" | ./ecm -cgbn 1e5 0
...
Computing 1792 Step 1 took 19ms of CPU time / 4786ms of GPU time

$ echo "(2^499-1)/20959" | ./ecm -cgbn 2e5 0
...
Computing 1792 Step 1 took 17ms of CPU time / 8911ms of GPU time
```
Here my 1080ti computes B1 for 256-512 bit inputs in `4786/1000/1e5/1792` = `2.67e-8` B1/curve/second

## CPU timing

To find my CPU's B1 timing I run the same without `-cgbn`

```
$ echo "(2^499-1)/20959" | ./ecm -param 3 1e5 0
Step 1 took 107ms

$ echo "(2^499-1)/20959" | ./ecm -param 3 1e6 0
Step 1 took 1075ms

$ echo "(2^499-1)/20959" | ./ecm -param 3 1e7 0
Step 1 took 10764ms
```

Again nice and linear. `1075/1000/1e6` = `1.08e-6` B1/curve/second

This makes each CPU core ~40x slower than my GPU.

## B2 timings

CPU B2 timings are not linear they instead appear to be on the order of B2^0.68.

I compute a number of values from 1e4 to 3e14 then linearly interpolate between them

You can see the [quality of this estimate](B2_timing.png)

To update these estimates run (NOTE: This will take ~10 minutes)

```
$ for e in {4..12}; do for r in {1,3}; do echo "(2^499-1)/20959" | ./ecm -param 3 1e3 ${r}e${e}; done; done | tee B2_update.log
$ cat B2_header.log B2_update.log > B2_timing.log
```


# Methodology

* For each t<X> (factor size)
  * Binary search for new optimal B1
  * For a given B1, bisect for B2 that matches the given B1/B2 ratio
    * It's hard to predict B2 timing so we simply measure it experimentally.
      * B1 << B2 so B1 largly doesn't affect B2 timings.
      * time(B2) ~ B2 ^ 0.68, which we can use to interpolate between B2 values
  * time for t<X> = curves(B1, B2) * timing(B1, B2)

# Results

## Some select results

|   GPU speedup/CPU cores|digits|     optimal B1|           optimal B2|B2/B1 ratio|expected curves|
|------------------------|------|---------------|---------------------|-----------|---------------|
|  1/1                   | 40   |     4,527,306 |       8,582,760,250 |      1896 |          1847 |
|  1/1                   | 45   |    15,176,672 |      70,312,974,861 |      4633 |          3673 |
|  1/1                   | 50   |    52,971,646 |     395,215,458,744 |      7461 |          6623 |
|  1/1                   | 55   |   196,443,940 |   4,827,804,775,096 |     24576 |         10027 |
|  1/1                   | 60   |   235,180,400 |   6,387,535,711,938 |     27160 |         46821 |
|  1/1                   | 65   |   958,146,588 | 105,114,974,739,570 |    109707 |         54484 |
|  1/1                   | 70   | 2,923,556,776 | 638,748,344,151,198 |    218483 |         89880 |
| Medium GPU + 1 cores   |      |               |                     |           |               |
| 20/1                   | 40   |     9,040,892 |         308,855,780 |        34 |          2579 |
| 20/1                   | 45   |    27,436,864 |       1,478,095,870 |        54 |          5332 |
| 20/1                   | 50   |   151,347,770 |      23,940,536,818 |       158 |          5559 |
| 20/1                   | 55   |   192,515,022 |      35,898,316,301 |       186 |         24493 |
| 20/1                   | 60   | 1,317,010,240 |     587,125,758,089 |       446 |         19569 |
| 20/1                   | 65   | 2,252,441,506 |   1,629,978,523,850 |       724 |         54589 |
| 20/1                   | 70   | 3,891,588,525 |   4,844,862,532,852 |      1245 |        148987 |
| Medium GPU + 4 cores   |      |               |                     |           |               |
| 20/4                   | 40   |     8,963,955 |       2,151,651,574 |       240 |          1565 |
| 20/4                   | 45   |    22,349,250 |       8,588,591,526 |       384 |          4068 |
| 20/4                   | 50   |    75,673,934 |      71,000,406,954 |       938 |          7219 |
| 20/4                   | 55   |    95,294,826 |      97,054,378,298 |      1018 |         34182 |
| 20/4                   | 60   |   332,612,280 |     584,604,637,119 |      1758 |         52345 |
| 20/4                   | 65   | 1,172,658,004 |   6,396,941,516,379 |      5455 |         70365 |
| 20/4                   | 70   | 4,092,979,506 |  78,655,995,166,042 |     19217 |         92864 |
| Extreme GPU + 1 cores  |      |               |                     |           |               |
| 50/1                   | 40   |    17,746,820 |         242,825,085 |        14 |          1917 |
| 50/1                   | 45   |    33,529,693 |         586,239,913 |        17 |          6481 |
| 50/1                   | 50   |   110,311,880 |       3,450,768,082 |        31 |         11183 |
| 50/1                   | 55   |   366,084,873 |      23,869,090,665 |        65 |         17124 |
| 50/1                   | 60   |   912,688,029 |      97,404,295,594 |       107 |         36247 |
| 50/1                   | 65   | 3,250,607,976 |     589,680,407,168 |       181 |         51582 |
| 50/1                   | 70   | 11,577,284,730 |   6,443,120,839,705 |       557 |         65144 |
| Extreme GPU + 4 cores  |      |               |                     |           |               |
| 50/4                   | 40   |     6,453,018 |         358,822,275 |        56 |          3043 |
| 50/4                   | 45   |    22,123,500 |       2,176,931,979 |        98 |          5658 |
| 50/4                   | 50   |    94,806,558 |      23,680,270,441 |       250 |          7513 |
| 50/4                   | 55   |   186,778,053 |      70,742,249,612 |       379 |         21847 |
| 50/4                   | 60   |   651,920,049 |     393,497,529,254 |       604 |         33327 |
| 50/4                   | 65   | 1,675,225,818 |   2,413,463,299,152 |      1441 |         63885 |
| 50/4                   | 70   | 2,923,556,776 |   6,409,632,338,818 |      2192 |        174629 |
| Extreme GPU + 8 cores  |      |               |                     |           |               |
| 50/8                   | 40   |     8,777,370 |       1,443,435,711 |       164 |          1710 |
| 50/8                   | 45   |    40,403,781 |      17,400,728,237 |       431 |          2414 |
| 50/8                   | 50   |    71,950,329 |      47,171,182,396 |       656 |          8095 |
| 50/8                   | 55   |   119,376,152 |      97,538,029,463 |       817 |         28667 |
| 50/8                   | 60   |   325,959,975 |     388,958,080,205 |      1193 |         56406 |
| 50/8                   | 65   | 1,221,010,140 |   4,822,560,705,477 |      3950 |         72316 |
| 50/8                   | 70   | 4,261,744,620 |  52,673,051,712,677 |     12360 |         96121 |
| Extreme GPU + 12 cores |      |               |                     |           |               |
| 50/12                  | 40   |     5,905,548 |       1,440,616,512 |       244 |          2213 |
| 50/12                  | 45   |    22,349,250 |      11,640,628,771 |       521 |          3856 |
| 50/12                  | 50   |    55,718,784 |      59,127,065,102 |      1061 |          9334 |
| 50/12                  | 55   |   184,891,406 |     289,406,096,765 |      1565 |         16359 |
| 50/12                  | 60   |   651,920,049 |   3,238,724,225,895 |      4968 |         24015 |
| 50/12                  | 65   | 3,416,455,350 |  78,861,587,213,348 |     23083 |         22732 |
| 50/12                  | 70   | 4,011,119,910 | 106,322,531,056,643 |     26507 |         89526 |


## Full Results
|   GPU speedup/CPU cores|digits|     optimal B1|           optimal B2|B2/B1 ratio|expected curves|
|------------------------|------|---------------|---------------------|-----------|---------------|
|  1/1                   | 40   |     4,527,306 |       8,582,760,250 |      1896 |          1847 |
|  1/1                   | 45   |    15,176,672 |      70,312,974,861 |      4633 |          3673 |
|  1/1                   | 50   |    52,971,646 |     395,215,458,744 |      7461 |          6623 |
|  1/1                   | 55   |   196,443,940 |   4,827,804,775,096 |     24576 |         10027 |
|  1/1                   | 60   |   235,180,400 |   6,387,535,711,938 |     27160 |         46821 |
|  1/1                   | 65   |   958,146,588 | 105,114,974,739,570 |    109707 |         54484 |
|  1/1                   | 70   | 2,923,556,776 | 638,748,344,151,198 |    218483 |         89880 |
| Medium GPU + 1 cores   |      |               |                     |           |               |
| 20/1                   | 40   |     9,040,892 |         308,855,780 |        34 |          2579 |
| 20/1                   | 45   |    27,436,864 |       1,478,095,870 |        54 |          5332 |
| 20/1                   | 50   |   151,347,770 |      23,940,536,818 |       158 |          5559 |
| 20/1                   | 55   |   192,515,022 |      35,898,316,301 |       186 |         24493 |
| 20/1                   | 60   | 1,317,010,240 |     587,125,758,089 |       446 |         19569 |
| 20/1                   | 65   | 2,252,441,506 |   1,629,978,523,850 |       724 |         54589 |
| 20/1                   | 70   | 3,891,588,525 |   4,844,862,532,852 |      1245 |        148987 |
| Medium GPU + 4 cores   |      |               |                     |           |               |
| 20/4                   | 40   |     8,963,955 |       2,151,651,574 |       240 |          1565 |
| 20/4                   | 45   |    22,349,250 |       8,588,591,526 |       384 |          4068 |
| 20/4                   | 50   |    75,673,934 |      71,000,406,954 |       938 |          7219 |
| 20/4                   | 55   |    95,294,826 |      97,054,378,298 |      1018 |         34182 |
| 20/4                   | 60   |   332,612,280 |     584,604,637,119 |      1758 |         52345 |
| 20/4                   | 65   | 1,172,658,004 |   6,396,941,516,379 |      5455 |         70365 |
| 20/4                   | 70   | 4,092,979,506 |  78,655,995,166,042 |     19217 |         92864 |
| Medium GPU + 8 cores   |      |               |                     |           |               |
| 20/8                   | 40   |     4,527,306 |       2,143,879,305 |       474 |          2494 |
| 20/8                   | 45   |    19,401,624 |      23,656,247,331 |      1219 |          3672 |
| 20/8                   | 50   |    37,836,918 |      70,412,992,954 |      1861 |         12068 |
| 20/8                   | 55   |   132,065,192 |     395,229,343,643 |      2993 |         19768 |
| 20/8                   | 60   |   489,755,280 |   4,818,412,911,594 |      9838 |         27663 |
| 20/8                   | 65   | 2,393,179,740 | 105,101,859,436,029 |     43917 |         27521 |
| 20/8                   | 70   | 3,072,717,774 | 159,237,086,873,881 |     51823 |        104771 |
| Medium GPU + 12 cores  |      |               |                     |           |               |
| 20/12                  | 40   |     8,963,955 |      11,525,739,091 |      1286 |          1103 |
| 20/12                  | 45   |    22,349,250 |      58,840,171,825 |      2633 |          2896 |
| 20/12                  | 50   |    74,160,324 |     289,160,009,704 |      3899 |          5507 |
| 20/12                  | 55   |   188,664,700 |   1,594,637,178,898 |      8452 |         12108 |
| 20/12                  | 60   |   325,959,975 |   4,798,554,609,136 |     14721 |         37878 |
| 20/12                  | 65   | 1,608,886,776 | 106,619,237,922,525 |     66269 |         36580 |
| 20/12                  | 70   | 3,891,588,525 | 429,323,815,387,252 |    110321 |         75514 |
| Fast GPU + 1 cores     |      |               |                     |           |               |
| 30/1                   | 40   |    12,676,300 |         292,175,293 |        23 |          2150 |
| 30/1                   | 45   |    40,403,781 |       1,489,437,362 |        37 |          4210 |
| 30/1                   | 50   |   154,436,520 |      11,789,392,169 |        76 |          6522 |
| 30/1                   | 55   |   337,664,745 |      47,622,595,111 |       141 |         15823 |
| 30/1                   | 60   |   556,899,994 |      97,046,749,025 |       174 |         51221 |
| 30/1                   | 65   | 1,545,174,722 |     393,607,961,235 |       255 |         91999 |
| 30/1                   | 70   | 5,788,642,365 |   4,810,209,310,533 |       831 |        110966 |
| Fast GPU + 4 cores     |      |               |                     |           |               |
| 30/4                   | 40   |     8,956,514 |       1,062,778,965 |       119 |          1813 |
| 30/4                   | 45   |    20,822,354 |       4,368,642,215 |       210 |          5081 |
| 30/4                   | 50   |    72,677,192 |      35,228,551,904 |       485 |          8411 |
| 30/4                   | 55   |   190,589,850 |     145,625,171,792 |       764 |         18871 |
| 30/4                   | 60   |   499,403,322 |     587,807,287,346 |      1177 |         38198 |
| 30/4                   | 65   | 1,454,305,986 |   4,769,231,909,884 |      3279 |         63289 |
| 30/4                   | 70   | 6,145,435,672 |  78,964,245,156,763 |     12849 |         68999 |
| Fast GPU + 8 cores     |      |               |                     |           |               |
| 30/8                   | 40   |     5,392,332 |       1,473,415,880 |       273 |          2349 |
| 30/8                   | 45   |    28,859,787 |      23,454,719,736 |       813 |          2796 |
| 30/8                   | 50   |    71,223,558 |      96,247,575,036 |      1351 |          7034 |
| 30/8                   | 55   |    95,294,826 |     144,783,104,848 |      1519 |         32239 |
| 30/8                   | 60   |   249,875,220 |     584,908,286,460 |      2341 |         66061 |
| 30/8                   | 65   | 2,298,409,778 |  39,389,008,020,278 |     17138 |         32845 |
| 30/8                   | 70   | 3,589,477,254 | 105,199,869,799,084 |     29308 |         97264 |
| Fast GPU + 12 cores    |      |               |                     |           |               |
| 30/12                  | 40   |     4,527,306 |       2,143,879,305 |       474 |          2494 |
| 30/12                  | 45   |    19,401,624 |      23,656,247,331 |      1219 |          3672 |
| 30/12                  | 50   |    37,836,918 |      70,412,992,954 |      1861 |         12068 |
| 30/12                  | 55   |   132,065,192 |     395,229,343,643 |      2993 |         19768 |
| 30/12                  | 60   |   489,755,280 |   4,818,412,911,594 |      9838 |         27663 |
| 30/12                  | 65   | 2,393,179,740 | 105,101,859,436,029 |     43917 |         27521 |
| 30/12                  | 70   | 3,072,717,774 | 159,237,086,873,881 |     51823 |        104771 |
| Extreme GPU + 1 cores  |      |               |                     |           |               |
| 50/1                   | 40   |    17,746,820 |         242,825,085 |        14 |          1917 |
| 50/1                   | 45   |    33,529,693 |         586,239,913 |        17 |          6481 |
| 50/1                   | 50   |   110,311,880 |       3,450,768,082 |        31 |         11183 |
| 50/1                   | 55   |   366,084,873 |      23,869,090,665 |        65 |         17124 |
| 50/1                   | 60   |   912,688,029 |      97,404,295,594 |       107 |         36247 |
| 50/1                   | 65   | 3,250,607,976 |     589,680,407,168 |       181 |         51582 |
| 50/1                   | 70   | 11,577,284,730 |   6,443,120,839,705 |       557 |         65144 |
| Extreme GPU + 4 cores  |      |               |                     |           |               |
| 50/4                   | 40   |     6,453,018 |         358,822,275 |        56 |          3043 |
| 50/4                   | 45   |    22,123,500 |       2,176,931,979 |        98 |          5658 |
| 50/4                   | 50   |    94,806,558 |      23,680,270,441 |       250 |          7513 |
| 50/4                   | 55   |   186,778,053 |      70,742,249,612 |       379 |         21847 |
| 50/4                   | 60   |   651,920,049 |     393,497,529,254 |       604 |         33327 |
| 50/4                   | 65   | 1,675,225,818 |   2,413,463,299,152 |      1441 |         63885 |
| 50/4                   | 70   | 2,923,556,776 |   6,409,632,338,818 |      2192 |        174629 |
| Extreme GPU + 8 cores  |      |               |                     |           |               |
| 50/8                   | 40   |     8,777,370 |       1,443,435,711 |       164 |          1710 |
| 50/8                   | 45   |    40,403,781 |      17,400,728,237 |       431 |          2414 |
| 50/8                   | 50   |    71,950,329 |      47,171,182,396 |       656 |          8095 |
| 50/8                   | 55   |   119,376,152 |      97,538,029,463 |       817 |         28667 |
| 50/8                   | 60   |   325,959,975 |     388,958,080,205 |      1193 |         56406 |
| 50/8                   | 65   | 1,221,010,140 |   4,822,560,705,477 |      3950 |         72316 |
| 50/8                   | 70   | 4,261,744,620 |  52,673,051,712,677 |     12360 |         96121 |
| Extreme GPU + 12 cores |      |               |                     |           |               |
| 50/12                  | 40   |     5,905,548 |       1,440,616,512 |       244 |          2213 |
| 50/12                  | 45   |    22,349,250 |      11,640,628,771 |       521 |          3856 |
| 50/12                  | 50   |    55,718,784 |      59,127,065,102 |      1061 |          9334 |
| 50/12                  | 55   |   184,891,406 |     289,406,096,765 |      1565 |         16359 |
| 50/12                  | 60   |   651,920,049 |   3,238,724,225,895 |      4968 |         24015 |
| 50/12                  | 65   | 3,416,455,350 |  78,861,587,213,348 |     23083 |         22732 |
| 50/12                  | 70   | 4,011,119,910 | 106,322,531,056,643 |     26507 |         89526 |

