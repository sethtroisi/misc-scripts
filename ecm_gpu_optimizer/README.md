# GMP-ECM GPU Optimizer

Try to optimize B1/B2 bounds when B1 is run on GPU at a non-trivial speedup.

Given a B1 speedup compute optimal B1/B2 params.


## GPU timing

I calculate my GPU's B1 speed with

```
$ echo "(2^499-1)/20959" | ./ecm -cgbn 1e5 0
...
Computing 1792 Step 1 took 19ms of CPU time / 4786ms of GPU time

$ echo "(2^499-1)/20959" | ./ecm -cgbn 2e5 0
...
Computing 1792 Step 1 took 17ms of CPU time / 8911ms of GPU time
```
Here my 1080ti computes B1 for 256-512 bit inputs in `4786/1000/1e5/1792` = `2.67e-8` B1/curve/second

## CPU timing

To find my CPU's B1 timing I run the same without `-cgbn`

```
$ echo "(2^499-1)/20959" | ./ecm -param 3 1e5 0
Step 1 took 107ms

$ echo "(2^499-1)/20959" | ./ecm -param 3 1e6 0
Step 1 took 1075ms

$ echo "(2^499-1)/20959" | ./ecm -param 3 1e7 0
Step 1 took 10764ms
```

Again nice and linear. `1075/1000/1e6` = `1.08e-6` B1/curve/second

This makes each CPU core ~40x slower than my GPU.

# Methodology

* For each t<X> (factor size)
  * Binary search for new optimal B1
  * For a given B1, bisect for B2 that matches the given B1/B2 ratio
    * It's hard to predict B2 timing so we simply measure it experimentally.
      * B1 << B2 so B1 largly doesn't affect B2 timings.
      * time(B2) ~ B2 ^ 0.685, which we can use to interpolate between B2 values
  * time for t<X> = curves(B1, B2) * timing(B1, B2)

# Results

|GPU speedup/CPU cores|digits|   optimal B1|       optimal B2|B2/B1 ratio|expected curves|
|---------------------|------|-------------|-----------------|-----------|---------------|
|  1/1                | 35   |   1,296,736 |   2,864,373,598 |      2209 |           747 |
|  1/1                | 40   |   5,965,260 |  35,577,578,256 |      5964 |          1185 |
|  1/1                | 45   |  11,517,940 |  96,538,211,887 |      8382 |          4260 |
|  1/1                | 50   |  40,993,128 | 583,432,032,753 |     14232 |          7619 |
|  1/1                | 55   | 261,489,096 | 19,329,077,452,040 |     73919 |          6694 |
|  1/1                | 60   | 489,755,280 | 78,969,500,163,456 |    161243 |         18395 |
| Slow GPU + 1 cores  |      |             |                 |           |               |
| 20/1                | 35   |   1,113,156 |      33,149,045 |        30 |          2466 |
| 20/1                | 40   |   6,082,758 |     355,089,247 |        58 |          3155 |
| 20/1                | 45   |  39,199,347 |   5,778,412,656 |       147 |          3136 |
| 20/1                | 50   |  76,446,117 |  17,332,033,300 |       227 |          9341 |
| 20/1                | 55   | 179,381,565 |  70,660,308,608 |       394 |         22527 |
| 20/1                | 60   | 353,113,458 | 174,512,466,585 |       494 |         65752 |
| Slow GPU + 4 cores  |      |             |                 |           |               |
| 20/4                | 35   |   1,559,844 |     351,804,250 |       226 |          1038 |
| 20/4                | 40   |   6,467,580 |   2,889,567,750 |       447 |          1843 |
| 20/4                | 45   |  29,448,837 |  35,181,170,876 |      1195 |          2599 |
| 20/4                | 50   |  40,201,280 |  58,928,323,592 |      1466 |         11993 |
| 20/4                | 55   | 136,135,593 | 289,565,678,027 |      2127 |         20547 |
| 20/4                | 60   | 479,960,096 | 3,226,409,839,042 |      6722 |         30014 |
| Slow GPU + 8 cores  |      |             |                 |           |               |
| 20/8                | 35   |   1,797,147 |   1,048,706,353 |       584 |           719 |
| 20/8                | 40   |   4,133,844 |   4,297,604,613 |      1040 |          2325 |
| 20/8                | 45   |  14,873,068 |  35,581,748,941 |      2392 |          4203 |
| 20/8                | 50   |  28,715,260 |  96,485,423,067 |      3360 |         14056 |
| 20/8                | 55   | 269,520,972 | 4,027,961,564,294 |     14945 |          8323 |
| 20/8                | 60   | 921,907,168 | 40,135,683,161,686 |     43535 |         12888 |
| Slow GPU + 12 cores |      |             |                 |           |               |
| 20/12               | 35   |   1,778,994 |   2,145,735,820 |      1206 |           632 |
| 20/12               | 40   |   4,527,306 |   8,612,614,153 |      1902 |          1847 |
| 20/12               | 45   |  15,331,536 |  71,195,276,126 |      4644 |          3640 |
| 20/12               | 50   |  54,052,782 | 394,239,535,216 |      7294 |          6509 |
| 20/12               | 55   | 138,913,929 | 2,425,054,096,560 |     17457 |         14430 |
| 20/12               | 60   | 237,580,200 | 6,408,824,590,479 |     26975 |         46377 |
| Medium GPU + 1 cores |      |             |                 |           |               |
| 30/1                | 35   |   1,218,294 |      23,716,051 |        19 |          2560 |
| 30/1                | 40   |   8,963,955 |     356,601,460 |        40 |          2478 |
| 30/1                | 45   |  30,972,900 |   2,195,558,265 |        71 |          4553 |
| 30/1                | 50   |  78,794,240 |   8,734,513,563 |       111 |         10520 |
| 30/1                | 55   | 269,520,972 |  71,421,322,412 |       265 |         16890 |
| 30/1                | 60   | 339,400,314 |  97,405,625,398 |       287 |         74164 |
| Medium GPU + 4 cores |      |             |                 |           |               |
| 30/4                | 35   |   2,320,362 |     350,255,484 |       151 |           802 |
| 30/4                | 40   |   6,269,452 |   1,447,779,916 |       231 |          2128 |
| 30/4                | 45   |  29,151,374 |  17,250,741,181 |       592 |          2969 |
| 30/4                | 50   |  52,441,884 |  47,656,446,802 |       909 |         10166 |
| 30/4                | 55   |  86,138,712 |  97,463,555,347 |      1131 |         37224 |
| 30/4                | 60   | 894,434,240 | 4,838,992,539,126 |      5410 |         17894 |
| Medium GPU + 8 cores |      |             |                 |           |               |
| 30/8                | 35   |   1,171,786 |     351,250,493 |       300 |          1268 |
| 30/8                | 40   |   6,211,338 |   4,327,333,391 |       697 |          1738 |
| 30/8                | 45   |  22,123,500 |  35,162,808,257 |      1589 |          3152 |
| 30/8                | 50   |  43,281,112 |  97,344,527,443 |      2249 |         10158 |
| 30/8                | 55   | 120,594,276 | 390,062,752,923 |      3235 |         21265 |
| 30/8                | 60   | 447,217,056 | 4,820,448,674,522 |     10779 |         29605 |
| Medium GPU + 12 cores |      |             |                 |           |               |
| 30/12               | 35   |   1,797,147 |   1,048,706,353 |       584 |           719 |
| 30/12               | 40   |   4,133,844 |   4,297,604,613 |      1040 |          2325 |
| 30/12               | 45   |  14,873,068 |  35,581,748,941 |      2392 |          4203 |
| 30/12               | 50   |  28,715,260 |  96,485,423,067 |      3360 |         14056 |
| 30/12               | 55   | 269,520,972 | 4,027,961,564,294 |     14945 |          8323 |
| 30/12               | 60   | 921,907,168 | 40,135,683,161,686 |     43535 |         12888 |
| Fast GPU + 1 cores  |      |             |                 |           |               |
| 40/1                | 35   |   1,869,759 |      28,520,585 |        15 |          1850 |
| 40/1                | 40   |  12,024,600 |     368,585,306 |        31 |          2059 |
| 40/1                | 45   |  16,125,060 |     548,777,743 |        34 |         10427 |
| 40/1                | 50   | 151,347,770 |  17,577,275,236 |       116 |          5975 |
| 40/1                | 55   | 272,271,186 |  47,584,232,327 |       175 |         18352 |
| 40/1                | 60   | 447,217,056 |  96,663,579,302 |       216 |         59996 |
| Fast GPU + 4 cores  |      |             |                 |           |               |
| 40/4                | 35   |   2,567,367 |     264,075,603 |       103 |           809 |
| 40/4                | 40   |   8,351,462 |   1,459,547,807 |       175 |          1760 |
| 40/4                | 45   |  38,803,644 |  17,323,036,685 |       446 |          2481 |
| 40/4                | 50   |  79,534,840 |  58,654,664,284 |       737 |          7269 |
| 40/4                | 55   | 113,502,213 |  96,313,119,323 |       849 |         29883 |
| 40/4                | 60   | 322,667,450 | 395,167,622,450 |      1225 |         56664 |
| Fast GPU + 8 cores  |      |             |                 |           |               |
| 40/8                | 35   |   1,559,844 |     351,804,250 |       226 |          1038 |
| 40/8                | 40   |   6,467,580 |   2,889,567,750 |       447 |          1843 |
| 40/8                | 45   |  29,448,837 |  35,181,170,876 |      1195 |          2599 |
| 40/8                | 50   |  40,201,280 |  58,928,323,592 |      1466 |         11993 |
| 40/8                | 55   | 136,135,593 | 289,565,678,027 |      2127 |         20547 |
| 40/8                | 60   | 479,960,096 | 3,226,409,839,042 |      6722 |         30014 |
| Fast GPU + 12 cores |      |             |                 |           |               |
| 40/12               | 35   |   1,058,890 |     359,429,899 |       339 |          1358 |
| 40/12               | 40   |   9,054,500 |   8,652,339,937 |       956 |          1148 |
| 40/12               | 45   |  15,644,475 |  23,792,143,189 |      1521 |          4289 |
| 40/12               | 50   |  38,223,009 |  96,438,703,409 |      2523 |         11186 |
| 40/12               | 55   | 136,135,593 | 582,592,558,787 |      4280 |         18334 |
| 40/12               | 60   | 475,160,400 | 6,418,675,233,920 |     13508 |         26735 |
| Extreme GPU + 1 cores |      |             |                 |           |               |
| 50/1                | 35   |   2,043,006 |      25,014,788 |        12 |          1830 |
| 50/1                | 40   |  13,851,234 |     334,316,672 |        24 |          1987 |
| 50/1                | 45   |  39,595,644 |   1,481,083,749 |        37 |          4247 |
| 50/1                | 50   |  78,006,258 |   4,403,734,190 |        56 |         12959 |
| 50/1                | 55   | 337,664,880 |  47,431,478,806 |       140 |         15953 |
| 50/1                | 60   | 556,899,994 |  96,925,369,932 |       174 |         51221 |
| Extreme GPU + 4 cores |      |             |                 |           |               |
| 50/4                | 35   |   2,541,434 |     175,630,774 |        69 |           903 |
| 50/4                | 40   |   8,873,410 |   1,068,768,814 |       120 |          1829 |
| 50/4                | 45   |  20,405,854 |   4,330,104,812 |       212 |          5177 |
| 50/4                | 50   |  73,418,796 |  35,759,851,909 |       487 |          8335 |
| 50/4                | 55   | 192,515,022 | 145,852,578,156 |       758 |         18694 |
| 50/4                | 60   | 867,691,510 | 1,612,601,559,529 |      1858 |         21548 |
| Extreme GPU + 8 cores |      |             |                 |           |               |
| 50/8                | 35   |   1,607,886 |     261,499,681 |       163 |          1092 |
| 50/8                | 40   |   6,661,525 |   2,174,209,443 |       326 |          1896 |
| 50/8                | 45   |  29,151,374 |  23,726,314,380 |       814 |          2787 |
| 50/8                | 50   |  71,230,797 |  96,240,191,725 |      1351 |          7034 |
| 50/8                | 55   |  96,257,462 | 145,099,061,653 |      1507 |         31926 |
| 50/8                | 60   | 671,944,056 | 4,024,257,676,272 |      5989 |         22750 |
| Extreme GPU + 12 cores |      |             |                 |           |               |
| 50/12               | 35   |   1,296,736 |     349,615,803 |       270 |          1185 |
| 50/12               | 40   |   4,436,754 |   2,155,788,066 |       486 |          2522 |
| 50/12               | 45   |  19,401,624 |  23,533,493,144 |      1213 |          3672 |
| 50/12               | 50   |  37,840,770 |  70,299,316,234 |      1858 |         12068 |
| 50/12               | 55   | 134,760,486 | 394,329,274,755 |      2926 |         19500 |
| 50/12               | 60   | 595,236,320 | 6,444,815,097,559 |     10827 |         22627 |

